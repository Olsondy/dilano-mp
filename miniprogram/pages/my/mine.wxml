<!--miniprogram/pages/my/mine.wxml-->
<view class="page-container">
  <t-toast id="t-toast" />
  <navigation-bar title="{{text.pageTitle}}" back="{{false}}" color="#000" background="#FFF"></navigation-bar>
  
  <view class="content-wrapper">
    <!-- Profile Header -->
    <view class="profile-section">
      <view class="avatar-container">
         <image class="avatar" src="{{userInfo.avatar}}" mode="aspectFill"></image>
      </view>
      <view class="profile-info">
        <view class="name-row">
            <text class="nickname">{{userInfo.nickname}}</text>
            <view class="role-badge">{{userInfo.role}}</view>
        </view>
        <text class="user-id" bindtap="handleCopyId">{{userInfo.phone}}</text>
      </view>
    </view>

    <!-- Stats Grid (Linear Style) -->
    <view class="stats-grid">
      <view class="stat-card">
        <text class="stat-label">{{text.commissionLabel}}</text>
        <text class="stat-value">¥{{commission}}</text>
      </view>
      <view class="stat-card">
        <text class="stat-label">{{text.referrerLabel}}</text>
        <text class="stat-value">{{referrer}}</text>
      </view>
      <view class="stat-card" bindtap="openReferrals" hover-class="item-active">
        <text class="stat-label">{{text.referrals}}</text>
        <text class="stat-value">{{referralList.length}}</text>
      </view>
    </view>

    <!-- General Section -->
    <view class="menu-group">
        <view class="section-label">{{text.generalSection}}</view>
        <view class="menu-list">
            <view class="menu-item" hover-class="item-active" bindtap="toggleLanguage">
                <text class="item-text">{{text.language}}</text>
                <view class="item-right">
                    <text class="value-text">{{currentLang === 'en' ? 'English' : '中文'}}</text>
                    <view class="arrow-right"></view>
                </view>
            </view>
        </view>
    </view>

    <!-- Support Section -->
    <view class="menu-group">
        <view class="section-label">{{text.supportSection}}</view>
        <view class="menu-list">
            <button class="menu-item-btn" open-type="contact">
                <view class="menu-item">
                    <text class="item-text">{{text.contact}}</text>
                    <view class="item-right">
                        <view class="arrow-right"></view>
                    </view>
                </view>
            </button>
            <button class="menu-item-btn" open-type="feedback">
                <view class="menu-item">
                    <text class="item-text">{{text.feedback}}</text>
                    <view class="item-right">
                        <view class="arrow-right"></view>
                    </view>
                </view>
            </button>
            <!-- <view class="menu-item" hover-class="item-active" bindtap="handleClearCache">
                <text class="item-text">{{text.clearCache}}</text>
                <view class="item-right">
                    <text class="value-text">{{storageSize}}</text>
                    <view class="arrow-right"></view>
                </view>
            </view> -->
        </view>
    </view>

    <!-- Legal Section -->
    <view class="menu-group">
        <view class="section-label">{{text.legalSection}}</view>
        <view class="menu-list">
            <view class="menu-item" hover-class="item-active" bindtap="handleAgreement">
                <text class="item-text">{{text.userAgreement}}</text>
                <view class="item-right">
                    <view class="arrow-right"></view>
                </view>
            </view>
            <view class="menu-item" hover-class="item-active" bindtap="handlePrivacy">
                <text class="item-text">{{text.privacy}}</text>
                <view class="item-right">
                    <view class="arrow-right"></view>
                </view>
            </view>
            <view class="menu-item" hover-class="item-active" bindtap="handleDeleteAccount">
                <text class="item-text" style="color: #E5484D;">{{text.deleteAccount}}</text>
                <view class="item-right">
                    <view class="arrow-right"></view>
                </view>
            </view>
        </view>
    </view>

    <!-- About Section -->
    <view class="menu-group">
        <view class="menu-list">
            <view class="menu-item">
                <text class="item-text">{{text.about}}</text>
                <view class="item-right">
                    <text class="value-text">{{text.footer}}</text>
                </view>
            </view>
        </view>
    </view>

    <view class="footer-action" bindtap="handleLogout">
        <text class="logout-text">{{text.logout}}</text>
    </view>
  </view>

  <!-- Login Popup -->
  <t-popup visible="{{showLogin}}" bind:visible-change="onVisibleChange" placement="bottom" close-on-overlay-click="{{false}}">
    <view class="login-popup-content">
      <view class="login-header">
        <text class="login-title">{{text.loginTitle}}</text>
        <text class="login-desc">{{text.loginDesc}}</text>
      </view>

      <view class="login-tip {{showAgreementError ? 'show' : ''}}">
        <text>{{text.agreeErr}}{{text.userAgreement}}{{text.andText}}{{text.privacyLink}}</text>
      </view>

      <t-button 
        wx:if="{{!privacyAgreed}}"
        t-class="login-btn-black"
        theme="primary" 
        size="large" 
        block 
        bind:tap="handleLoginCheck"
      >
        {{text.loginBtn}}
      </t-button>
      <t-button
        wx:else
        t-class="login-btn-black"
        theme="primary" 
        size="large" 
        block 
        open-type="getPhoneNumber" 
        bind:getphonenumber="handleLogin"
      >
        {{text.loginBtn}}
      </t-button>
      <view class="privacy-row" bindtap="togglePrivacy">
        <t-icon name="{{privacyAgreed ? 'check-circle-filled' : 'circle'}}" size="36rpx" color="{{privacyAgreed ? '#18181B' : '#999'}}" style="margin-top: 2rpx;" />
        <view class="privacy-text">
            <text>{{text.agreeText}}</text>
            <text class="link" catchtap="handleAgreement">{{text.userAgreement}}</text>
            <text>{{text.andText}}</text>
            <text class="link" catchtap="handlePrivacy">{{text.privacyLink}}</text>
        </view>
      </view>
    </view>
  </t-popup>

  <!-- Referral List Popup -->
  <t-popup visible="{{showReferrals}}" bind:visible-change="onReferralsVisibleChange" placement="bottom">
    <view class="referral-popup-content">
      <view class="referral-header">
        <text class="title">{{text.referrals}}</text>
        <view class="close-btn" bindtap="closeReferrals">✕</view>
      </view>
      <scroll-view scroll-y class="referral-list">
        <block wx:for="{{referralList}}" wx:key="id">
            <view class="referral-item">
                <text class="name">{{item.partyName}}</text>
            </view>
        </block>
        <view class="list-footer">Total: {{referralList.length}}</view>
      </scroll-view>
    </view>
  </t-popup>
</view>